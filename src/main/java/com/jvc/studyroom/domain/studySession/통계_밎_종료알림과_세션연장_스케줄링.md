### 설계 프롬프트

지금 인텔리제이로 보여지고 있는 studyroom-backend에 하루마다 공부시간에 대한 내용을 통계적으로 보여주는 기능을 만들려고 해.
지금 이벤트 기반으로 session을 만든게 아니고 한 세션에 대해 상태값을 바꿔가며 같은 row에 공부시간과 휴게시간을 축적하며 계산하고 있어.
그런데 결국 이 session은 처음 지정한 목표 시간을 채우게 되면 자동으로 종료된 걸로 가야해 .

1. 목표시간을 채우게 되면 자동으로 종료 되는 로직
2. 목표시간 10분전이 되면 사용자에게 (관리자 제외) 알림이 가서 연장할 건지 물어보고 연장을 할 수 있는 기능
3. 매일 오전6시마다 별도로 만들 통계 테이블(테이블 스키마 쿼리도 만들어줘)에 학생id별로 통계자료가 insert되는 기능 (일자/학생ID/총공부시간/총휴식시간/총세션유지시간(
   공부시간 +휴식시간))

이 기능들에 대한 기본 조건은

1. 매일 오전6시가 되면 자동으로 세션을 종료된다. (시간이 남아있어도)

우선 코드 직접 고치지 말고 설계를 나한테 보여줘

### 답변

현재 상황 분석

- 이벤트 기반이 아닌 단일 세션 row에서 상태값 변경으로 공부시간/휴게시간 관리
- 목표시간 달성 시 자동 종료 필요
- 매일 오전 6시 강제 종료 및 통계 집계 필요


1. 데이터베이스 설계
   기존 Session 테이블 (추정)
   sql-- 기존 테이블에 필요한 컬럼들
   ALTER TABLE sessions ADD COLUMN IF NOT EXISTS target_duration INT; -- 목표시간(분)
   ALTER TABLE sessions ADD COLUMN IF NOT EXISTS extension_requested BOOLEAN DEFAULT FALSE;
   ALTER TABLE sessions ADD COLUMN IF NOT EXISTS extension_granted_until TIMESTAMP;
   새로운 통계 테이블
   sqlCREATE TABLE daily_study_statistics (
   id BIGSERIAL PRIMARY KEY,
   study_date DATE NOT NULL,
   student_id BIGINT NOT NULL,
   total_study_time INT NOT NULL DEFAULT 0, -- 분 단위
   total_break_time INT NOT NULL DEFAULT 0, -- 분 단위
   total_session_time INT NOT NULL DEFAULT 0, -- 분 단위 (공부시간 + 휴식시간)
   session_count INT NOT NULL DEFAULT 0, -- 해당일 세션 수
   created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
   updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

   UNIQUE(study_date, student_id),
   FOREIGN KEY (student_id) REFERENCES users(id)
   );

CREATE INDEX idx_daily_statistics_date_student ON daily_study_statistics(study_date, student_id);
CREATE INDEX idx_daily_statistics_date ON daily_study_statistics(study_date);

2. 핵심 컴포넌트 설계
   A. SessionAutoTerminationService
   책임: 목표시간 달성 감지 및 자동 종료

- checkTargetTimeReached(sessionId): 목표시간 체크
- terminateSession(sessionId): 세션 종료 처리
- scheduleTargetTimeCheck(sessionId): 주기적 체크 스케줄링
  B. SessionNotificationService
  책임: 10분 전 알림 및 연장 처리
- schedulePreEndNotification(sessionId): 10분 전 알림 스케줄링
- sendExtensionNotification(studentId): 연장 알림 발송
- processExtensionRequest(sessionId, extensionMinutes): 연장 처리
- cancelExtensionNotification(sessionId): 알림 취소
  C. DailyStatisticsService
  책임: 통계 데이터 집계 및 관리
- aggregateDailyStatistics(date): 특정일 통계 집계
- forceTerminateAllSessions(): 모든 세션 강제 종료
- calculateSessionStatistics(sessionId): 세션별 통계 계산
  D. SessionScheduler
  책임: 스케줄링 작업 관리
- @Scheduled(cron = "0 0 6 * * *"): 매일 오전 6시 작업
- 진행중인 세션들의 목표시간 체크
- 10분 전 알림 스케줄링 관리

3. 핵심 로직 플로우
   A. 세션 시작 시
1. 세션 생성/재시작
2. 목표시간 기반 종료 시점 계산
3. 10분 전 알림 스케줄링
4. 목표시간 체크 스케줄링
   B. 세션 진행 중 (상태 업데이트 시)
1. 공부시간/휴식시간 누적 업데이트
2. 목표시간 달성 여부 체크
3. 달성 시 자동 종료 처리
   C. 10분 전 알림 처리
1. 관리자가 아닌 학생에게만 알림 발송
2. 연장 요청 대기 상태로 변경
3. 연장 승인 시 새로운 목표시간으로 업데이트
4. 새로운 10분 전 알림 재스케줄링
   D. 매일 오전 6시 처리
1. 모든 활성 세션 강제 종료
2. 전날(오전6시~오전6시) 통계 집계
3. daily_study_statistics 테이블에 insert/update
4. 필요 시 알림 스케줄 정리
4. 예외 상황 처리
   A. 연장 요청 관련

연장 요청 후 무응답 시 원래 계획대로 종료
연장 중 목표시간 재계산
연장 요청 취소 기능

B. 스케줄링 장애 대응

애플리케이션 재시작 시 기존 스케줄 복구
중복 알림 방지
세션 상태 불일치 해결

C. 통계 집계 실패 대응

실패한 날짜에 대한 재집계 기능
부분 데이터 처리 방안
트랜잭션 롤백 처리

5. 설정 및 구성
   A. 애플리케이션 설정
   yamlstudyroom:
   session:
   pre-end-notification-minutes: 10
   auto-termination-check-interval: 60000 # 1분
   daily-reset-time: "06:00"
   notification:
   extension-wait-timeout: 300000 # 5분
   B. 스케줄러 설정

고정 시간 스케줄: 매일 오전 6시
동적 스케줄: 세션별 목표시간 기반
실패 재시도 로직